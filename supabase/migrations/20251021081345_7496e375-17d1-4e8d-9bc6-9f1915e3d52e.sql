-- Update booth information from the new file
UPDATE booths SET 
  name = 'ì˜ì–´í† ë¡ ',
  teacher = 'ì§€ê²½ì£¼',
  description = 'ì¹œêµ¬ì™€ ì†ìž¡ê³  ì˜¤ì„¸ìš”! ì˜ì–´ ìŠ¤í”¼ë“œ í€´ì¦ˆ ðŸ’¬',
  location = '1ë²ˆ ë¶€ìŠ¤'
WHERE booth_id = 1;

UPDATE booths SET 
  name = 'KIKKER(êµ­ì œêµë¥˜ë°˜)',
  teacher = 'ì‹ í¬ì˜',
  description = 'íƒ‘ìŠ¹ê¶Œì„ ë°›ê³  ì„¸ê³„ ê³³ê³³ì˜ ì‚¬ëž‘ ë¬¸í™”ë¥¼ íƒí—˜í•˜ëŠ” ê¸€ë¡œë²Œ ì—¬í–‰ ðŸŒ',
  location = '2ë²ˆ ë¶€ìŠ¤'
WHERE booth_id = 2;

UPDATE booths SET 
  name = 'STEAMì‚¬íšŒì°¸ì—¬ë°˜',
  teacher = 'ì´ì€ì˜',
  description = 'ì‚¬ëž‘ì˜ ë‹¨ë§›ê³¼ ë§¤ìš´ë§›, ì–´ë–¤ ë§›ì´ ë” ê°•í• ê¹Œ? ðŸ­ ðŸ“¸ ì¸ìƒë„¤ì»· â€“ ìš°ë¦¬ ì§€ê¸ˆ, ì´ ìˆœê°„ì„ ë‚¨ê²¨ìš”!',
  location = '3ë²ˆ ë¶€ìŠ¤'
WHERE booth_id = 3;

UPDATE booths SET 
  name = 'í•™ìƒíšŒ',
  teacher = 'ì´ì€ì˜',
  description = 'ì¦‰ì„ ì‚¬ì§„ í•œ ì»·ìœ¼ë¡œ ì˜¤ëŠ˜ì˜ ì¶”ì–µì„ ì˜¤ëž˜ì˜¤ëž˜ ê°„ì§í•  ìˆ˜ ìžˆì–´ìš” ðŸ’•',
  location = '4ë²ˆ ë¶€ìŠ¤'
WHERE booth_id = 4;

UPDATE booths SET 
  name = 'ëž©í€˜ìŠ¤íŠ¸',
  teacher = 'ì •ìœ ì •',
  description = 'ê³¼í•™+ì‚¬ëž‘+ì¿ í‚¤ì˜ ë§Œë‚¨! ðŸª ì§ì ‘ ë§Œë“œëŠ” ë¶„ìžëª¨í˜• ì¿ í‚¤ë¡œ ë‹¬ì½¤í•œ ì‹¤í—˜ì„ ì¦ê²¨ìš” ðŸ§ª',
  location = '5ë²ˆ ë¶€ìŠ¤'
WHERE booth_id = 5;

UPDATE booths SET 
  name = 'ì†”ë¦¬ì–¸(ë˜ëž˜ìƒë‹´ë°˜)',
  teacher = 'ìœ¤ì§€ìˆ™',
  description = 'ë½‘ê¸°íŒ ì† ìž‘ì€ ì„ ë¬¼, í° ë§ˆìŒ ðŸ’Œ ë©”ì‹œì§€ë¡œ ì¹œêµ¬ì—ê²Œ ë”°ëœ»í•œ ë§ˆìŒì„ ì „í•´ìš” ðŸŽ',
  location = '6ë²ˆ ë¶€ìŠ¤'
WHERE booth_id = 6;

UPDATE booths SET 
  name = 'ì¹œí™˜ê²½ë™ì•„ë¦¬',
  teacher = 'ì´ìœ¤ì£¼',
  description = 'í™˜ê²½ ì§€í‚¤ê³  êµ¿ì¦ˆë„ GET! ðŸŒ¿ í…€ë¸”ëŸ¬ ì‚¬ìš© ê³ ê°ì—ê²Œ í‚¤ë§Â·ê·¸ë¦½í†¡ ì¦ì • ðŸŽ',
  location = '7ë²ˆ ë¶€ìŠ¤'
WHERE booth_id = 7;

UPDATE booths SET 
  name = 'ë¹…ë°ì´í„°íˆ¬ì¸ì‚¬ì´íŠ¸',
  teacher = 'ì´ì˜ì„',
  description = 'ë°ì´í„° ì†ì— ìˆ¨ì–´ìžˆëŠ” ì‚¬ëž‘ì„ ì°¾ì•„ë¼ ðŸ’» ë¹…ë°ì´í„°ë¡œ ì„¸ìƒì„ ì½ëŠ” íŠ¹ë³„í•œ ì¸ì‚¬ì´íŠ¸!',
  location = '8ë²ˆ ë¶€ìŠ¤'
WHERE booth_id = 8;

UPDATE booths SET 
  name = 'BUKU(ë…ì„œí† ë¡ ë°˜)',
  teacher = 'ì„œìˆ˜ëž€',
  description = 'ì—°ì•  MBTI âœ¨ ìš´ì„¸ ì¹´íŽ˜ â˜• ë¶í´ë¦½ ë§Œë“¤ê¸° âœ‚ ì‚¬ëž‘ê³¼ ê°ì„±ì´ ë§Œë‚˜ëŠ” ë¶ì¹´íŽ˜, ì˜¤ëŠ˜ì˜ ìš´ì„¸ëŠ”?',
  location = '9ë²ˆ ë¶€ìŠ¤'
WHERE booth_id = 9;

UPDATE booths SET 
  name = 'ë¹›ê¸€ (í•™ìƒê¸°ìžë°˜)',
  teacher = 'ì´ë¬¸ë•',
  description = 'ì£¼ì–´ì§„ ì£¼ì œì— ë§žëŠ” ì‚¬ëžŒì„ ì°¾ì•„ ë¶€ìŠ¤ë¡œ ë°ë ¤ì˜¤ë©´ ðŸŽ¯ í´ë¼ë¡œì´ë“œ ì‚¬ì§„ ì´¬ì˜ ê¸°íšŒê°€ ì£¼ì–´ì§‘ë‹ˆë‹¤ ðŸ“¸',
  location = '10ë²ˆ ë¶€ìŠ¤'
WHERE booth_id = 10;

UPDATE booths SET 
  name = 'ARTY ë¯¸ìˆ ë°˜',
  teacher = 'ì´ê·œí™”',
  description = 'íŽ˜ì´ìŠ¤íŽ˜ì¸íŒ…Â·ì¥¬ì–¼ë¦¬ ë©”ì´í¬ì—…Â·íƒ€íˆ¬ ê·¸ë¦¬ê³  ìŠ¤íŽ˜ì…œ ì²´í—˜ê¹Œì§€!! ì•„íŠ¸ ì²´í—˜ì¡´ ðŸ’Ž',
  location = '11ë²ˆ ë¶€ìŠ¤'
WHERE booth_id = 11;

UPDATE booths SET 
  name = 'ì¶•êµ¬ë°˜',
  teacher = 'í˜„ì¢…ëª…',
  description = 'ì‚¬ëž‘ì˜ ìŠ›! âš½ í”„ë¦¬ìŠ¤íƒ€ì¼ ì¶•êµ¬ì™€ ìŠ¹ë¶€ì°¨ê¸° ëŒ€ê²°, ìµœê³ ì˜ í”Œë ˆì´ì–´ì—ê²ŒëŠ” íŠ¹ë³„í•œ ì„ ë¬¼ ðŸŽ¯',
  location = '12ë²ˆ ë¶€ìŠ¤'
WHERE booth_id = 12;

UPDATE booths SET 
  name = 'ìŠ¬ëž¨ë©í¬ (ë†êµ¬ë™ì•„ë¦¬)',
  teacher = 'ì¡°ì •í˜„',
  description = 'ì§ì„ ì´ë¤„ ìŠ›ì„ ì‚¬ëž‘ì„ ì´ë¼! ðŸ€ ì„±ê³µì‹œí‚¤ë©´ ìƒí’ˆì€ ì§ê¿ì—ê²Œ ðŸ’ž',
  location = '13ë²ˆ ë¶€ìŠ¤'
WHERE booth_id = 13;

UPDATE booths SET 
  name = 'Ballin (ë°°êµ¬ë™ì•„ë¦¬)',
  teacher = 'ë°•ì°½ë¯¼',
  description = 'ë‘ì‚¬ëžŒì´ í•¨ê»˜ ì–¸ë” ë¦¬ì‹œë¸Œí•˜ê¸°! í˜¼ì„± ë° ì‚¬ì œì§€ê°„ì€ ê°¯ìˆ˜ê°€ ë” ë¸”!!',
  location = '14ë²ˆ ë¶€ìŠ¤'
WHERE booth_id = 14;

UPDATE booths SET 
  name = 'ì• ë“œë¯¸ì°¬ì–‘ë°˜',
  teacher = 'ì•ˆìœ ë¦°',
  description = 'ëª©ì†Œë¦¬ë¡œ ì „í•˜ëŠ” ì‚¬ëž‘ì˜ í•˜ëª¨ë‹ˆðŸŽ¤ ë§ˆìŒì„ ìš¸ë¦¬ëŠ” ì• ë“œë¯¸ ì°¬ì–‘ ë²„ìŠ¤í‚¹ ë¬´ëŒ€!',
  location = '15ë²ˆ ë¶€ìŠ¤ (ì¤‘ì•™êµ¬ë ¹ëŒ€)'
WHERE booth_id = 15;

UPDATE booths SET 
  name = 'ë¬¼ë¦¬ë¥¼ ë§Œë“¤ë‹¤',
  teacher = 'ê¹€ê¸°ì •',
  description = 'ê³¨ë“œë²„ê·¸ ìž¥ì¹˜ ì „ì‹œë¶€í„° ðŸ¤– ë¡œë´‡Â·ë“œë¡  ì¡°ì¢…ê¹Œì§€! í–‰ìš´ì˜ ëžœë¤ ë½‘ê¸°ë¡œ ì¦ê±°ì›€ê¹Œì§€ ë”í•˜ì„¸ìš”!',
  location = 'ê³¼í•™1ì‹¤'
WHERE booth_id = 16;

UPDATE booths SET 
  name = 'ìˆ˜ë‹¬(ìˆ˜í•™ì˜ë‹¬ì¸)',
  teacher = 'ì „ìŠ¹ì£¼',
  description = 'ê²Œìž„ ì†ì— ìˆ¨ì€ ìˆ˜í•™ì˜ ë§ˆë²• âœ¨ ì¦ê¸°ë©° ë°°ìš°ëŠ” ìˆ˜í•™ ë†€ì´í„°ë¡œ ì´ˆëŒ€í•©ë‹ˆë‹¤!',
  location = 'ë¯¸ìˆ 2ì‹¤'
WHERE booth_id = 17;

UPDATE booths SET 
  name = 'ë””ìžì¸ê³µì˜ˆë°˜',
  teacher = 'ì²œí˜œì‹¬',
  description = 'ì‚¬ëž‘ì„ ë‹´ì€ ë‚˜ë§Œì˜ ë””ìžì¸ðŸŽ¨ ë‚´ê°€ ì‚¬ëž‘í•˜ëŠ” ê²ƒë“¤ì„ êµ¿ì¦ˆë¡œ ë§Œë“¤ì–´ë³´ì„¸ìš”.',
  location = 'ê³¼í•™2ì‹¤'
WHERE booth_id = 18;

UPDATE booths SET 
  name = 'ìœµí•©ê³¼í•™STEAM ì£¼ì œ ì—°êµ¬ë°˜',
  teacher = 'ê¹€ì„±í™˜, ë°•íš¨ë¯¼',
  description = 'ë‹¹ì‹ ì˜ ë°©íƒˆì¶œ ê²Œìž„ ì£¼ì–´ì§„ ë‹¨ì„œë¥¼ ì¶”ë¦¬ë ¥, ì§€ê¸ˆ ì‹œí—˜ëŒ€ì—! í’€ê³  ì œí•œ ì‹œê°„ ì•ˆì— íƒˆì¶œí•˜ë¼! â°',
  location = 'ê³¼í•™3ì‹¤, ë¯¸ìˆ 1ì‹¤'
WHERE booth_id = 19;

UPDATE booths SET 
  name = 'AIÂ·SW ì½”ë”©ë°˜',
  teacher = 'ê¹€ì˜ˆì§€',
  description = 'ì½”ë“œë¡œ ì„¸ìƒì„ ì›€ì§ì´ë‹¤! í•™ìƒë“¤ì´ ë§Œë“  íŒŒì´ì¬Â·ì•„ë‘ì´ë…¸ ì°½ìž‘ë¬¼ì„ ì²´í—˜í•´ë³´ì„¸ìš” ðŸ’¡',
  location = 'ìœµí•©ê³¼í•™ì‹¤'
WHERE booth_id = 20;

-- Create lucky_draw_tickets table for the new tiered system
CREATE TABLE IF NOT EXISTS public.lucky_draw_tickets (
  id uuid NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  ticket_count integer NOT NULL DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  UNIQUE(user_id)
);

ALTER TABLE public.lucky_draw_tickets ENABLE ROW LEVEL SECURITY;

-- Users can view their own tickets
CREATE POLICY "Users can view their own tickets"
ON public.lucky_draw_tickets
FOR SELECT
USING (auth.uid() = user_id);

-- Admins can view all tickets
CREATE POLICY "Admins can view all tickets"
ON public.lucky_draw_tickets
FOR SELECT
USING (has_role(auth.uid(), 'admin'::app_role));

-- Create function to calculate and update lucky draw tickets based on stamp count
CREATE OR REPLACE FUNCTION public.update_lucky_draw_tickets(p_user_id uuid)
RETURNS integer
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path TO 'public'
AS $function$
DECLARE
  v_stamp_count int;
  v_ticket_count int;
  v_profile record;
BEGIN
  -- Count user's stamps
  SELECT count(*) INTO v_stamp_count
  FROM stamp_logs
  WHERE user_id = p_user_id;

  -- Calculate tickets based on stamp count
  v_ticket_count := 0;
  IF v_stamp_count >= 20 THEN
    v_ticket_count := 5;
  ELSIF v_stamp_count >= 15 THEN
    v_ticket_count := 3;
  ELSIF v_stamp_count >= 10 THEN
    v_ticket_count := 2;
  ELSIF v_stamp_count >= 5 THEN
    v_ticket_count := 1;
  END IF;

  -- Insert or update ticket count
  IF v_ticket_count > 0 THEN
    INSERT INTO lucky_draw_tickets(user_id, ticket_count)
    VALUES (p_user_id, v_ticket_count)
    ON CONFLICT (user_id) 
    DO UPDATE SET 
      ticket_count = v_ticket_count,
      updated_at = now();
      
    -- Get profile info and register for lucky draw if 20 stamps
    IF v_stamp_count >= 20 THEN
      SELECT name, student_id
      INTO v_profile
      FROM profiles
      WHERE id = p_user_id;
      
      -- Register for lucky draw if not already registered
      INSERT INTO lucky_draw_entries(user_id, name, student_id)
      VALUES (p_user_id, v_profile.name, v_profile.student_id)
      ON CONFLICT (user_id) DO NOTHING;
    END IF;
  END IF;

  RETURN v_ticket_count;
END;
$function$;