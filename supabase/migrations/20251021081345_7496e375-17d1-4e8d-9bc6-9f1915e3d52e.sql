-- Update booth information from the new file
UPDATE booths SET 
  name = '영어토론',
  teacher = '지경주',
  description = '친구와 손잡고 오세요! 영어 스피드 퀴즈 💬',
  location = '1번 부스'
WHERE booth_id = 1;

UPDATE booths SET 
  name = 'KIKKER(국제교류반)',
  teacher = '신희영',
  description = '탑승권을 받고 세계 곳곳의 사랑 문화를 탐험하는 글로벌 여행 🌍',
  location = '2번 부스'
WHERE booth_id = 2;

UPDATE booths SET 
  name = 'STEAM사회참여반',
  teacher = '이은영',
  description = '사랑의 단맛과 매운맛, 어떤 맛이 더 강할까? 🍭 📸 인생네컷 – 우리 지금, 이 순간을 남겨요!',
  location = '3번 부스'
WHERE booth_id = 3;

UPDATE booths SET 
  name = '학생회',
  teacher = '이은영',
  description = '즉석 사진 한 컷으로 오늘의 추억을 오래오래 간직할 수 있어요 💕',
  location = '4번 부스'
WHERE booth_id = 4;

UPDATE booths SET 
  name = '랩퀘스트',
  teacher = '정유정',
  description = '과학+사랑+쿠키의 만남! 🍪 직접 만드는 분자모형 쿠키로 달콤한 실험을 즐겨요 🧪',
  location = '5번 부스'
WHERE booth_id = 5;

UPDATE booths SET 
  name = '솔리언(또래상담반)',
  teacher = '윤지숙',
  description = '뽑기판 속 작은 선물, 큰 마음 💌 메시지로 친구에게 따뜻한 마음을 전해요 🎁',
  location = '6번 부스'
WHERE booth_id = 6;

UPDATE booths SET 
  name = '친환경동아리',
  teacher = '이윤주',
  description = '환경 지키고 굿즈도 GET! 🌿 텀블러 사용 고객에게 키링·그립톡 증정 🎁',
  location = '7번 부스'
WHERE booth_id = 7;

UPDATE booths SET 
  name = '빅데이터투인사이트',
  teacher = '이영석',
  description = '데이터 속에 숨어있는 사랑을 찾아라 💻 빅데이터로 세상을 읽는 특별한 인사이트!',
  location = '8번 부스'
WHERE booth_id = 8;

UPDATE booths SET 
  name = 'BUKU(독서토론반)',
  teacher = '서수란',
  description = '연애 MBTI ✨ 운세 카페 ☕ 북클립 만들기 ✂ 사랑과 감성이 만나는 북카페, 오늘의 운세는?',
  location = '9번 부스'
WHERE booth_id = 9;

UPDATE booths SET 
  name = '빛글 (학생기자반)',
  teacher = '이문덕',
  description = '주어진 주제에 맞는 사람을 찾아 부스로 데려오면 🎯 폴라로이드 사진 촬영 기회가 주어집니다 📸',
  location = '10번 부스'
WHERE booth_id = 10;

UPDATE booths SET 
  name = 'ARTY 미술반',
  teacher = '이규화',
  description = '페이스페인팅·쥬얼리 메이크업·타투 그리고 스페셜 체험까지!! 아트 체험존 💎',
  location = '11번 부스'
WHERE booth_id = 11;

UPDATE booths SET 
  name = '축구반',
  teacher = '현종명',
  description = '사랑의 슛! ⚽ 프리스타일 축구와 승부차기 대결, 최고의 플레이어에게는 특별한 선물 🎯',
  location = '12번 부스'
WHERE booth_id = 12;

UPDATE booths SET 
  name = '슬램덩크 (농구동아리)',
  teacher = '조정현',
  description = '짝을 이뤄 슛을 사랑을 쏴라! 🏀 성공시키면 상품은 짝꿍에게 💞',
  location = '13번 부스'
WHERE booth_id = 13;

UPDATE booths SET 
  name = 'Ballin (배구동아리)',
  teacher = '박창민',
  description = '두사람이 함께 언더 리시브하기! 혼성 및 사제지간은 갯수가 더 블!!',
  location = '14번 부스'
WHERE booth_id = 14;

UPDATE booths SET 
  name = '애드미찬양반',
  teacher = '안유린',
  description = '목소리로 전하는 사랑의 하모니🎤 마음을 울리는 애드미 찬양 버스킹 무대!',
  location = '15번 부스 (중앙구령대)'
WHERE booth_id = 15;

UPDATE booths SET 
  name = '물리를 만들다',
  teacher = '김기정',
  description = '골드버그 장치 전시부터 🤖 로봇·드론 조종까지! 행운의 랜덤 뽑기로 즐거움까지 더하세요!',
  location = '과학1실'
WHERE booth_id = 16;

UPDATE booths SET 
  name = '수달(수학의달인)',
  teacher = '전승주',
  description = '게임 속에 숨은 수학의 마법 ✨ 즐기며 배우는 수학 놀이터로 초대합니다!',
  location = '미술2실'
WHERE booth_id = 17;

UPDATE booths SET 
  name = '디자인공예반',
  teacher = '천혜심',
  description = '사랑을 담은 나만의 디자인🎨 내가 사랑하는 것들을 굿즈로 만들어보세요.',
  location = '과학2실'
WHERE booth_id = 18;

UPDATE booths SET 
  name = '융합과학STEAM 주제 연구반',
  teacher = '김성환, 박효민',
  description = '당신의 방탈출 게임 주어진 단서를 추리력, 지금 시험대에! 풀고 제한 시간 안에 탈출하라! ⏰',
  location = '과학3실, 미술1실'
WHERE booth_id = 19;

UPDATE booths SET 
  name = 'AI·SW 코딩반',
  teacher = '김예지',
  description = '코드로 세상을 움직이다! 학생들이 만든 파이썬·아두이노 창작물을 체험해보세요 💡',
  location = '융합과학실'
WHERE booth_id = 20;

-- Create lucky_draw_tickets table for the new tiered system
CREATE TABLE IF NOT EXISTS public.lucky_draw_tickets (
  id uuid NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  ticket_count integer NOT NULL DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  UNIQUE(user_id)
);

ALTER TABLE public.lucky_draw_tickets ENABLE ROW LEVEL SECURITY;

-- Users can view their own tickets
CREATE POLICY "Users can view their own tickets"
ON public.lucky_draw_tickets
FOR SELECT
USING (auth.uid() = user_id);

-- Admins can view all tickets
CREATE POLICY "Admins can view all tickets"
ON public.lucky_draw_tickets
FOR SELECT
USING (has_role(auth.uid(), 'admin'::app_role));

-- Create function to calculate and update lucky draw tickets based on stamp count
CREATE OR REPLACE FUNCTION public.update_lucky_draw_tickets(p_user_id uuid)
RETURNS integer
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path TO 'public'
AS $function$
DECLARE
  v_stamp_count int;
  v_ticket_count int;
  v_profile record;
BEGIN
  -- Count user's stamps
  SELECT count(*) INTO v_stamp_count
  FROM stamp_logs
  WHERE user_id = p_user_id;

  -- Calculate tickets based on stamp count
  v_ticket_count := 0;
  IF v_stamp_count >= 20 THEN
    v_ticket_count := 5;
  ELSIF v_stamp_count >= 15 THEN
    v_ticket_count := 3;
  ELSIF v_stamp_count >= 10 THEN
    v_ticket_count := 2;
  ELSIF v_stamp_count >= 5 THEN
    v_ticket_count := 1;
  END IF;

  -- Insert or update ticket count
  IF v_ticket_count > 0 THEN
    INSERT INTO lucky_draw_tickets(user_id, ticket_count)
    VALUES (p_user_id, v_ticket_count)
    ON CONFLICT (user_id) 
    DO UPDATE SET 
      ticket_count = v_ticket_count,
      updated_at = now();
      
    -- Get profile info and register for lucky draw if 20 stamps
    IF v_stamp_count >= 20 THEN
      SELECT name, student_id
      INTO v_profile
      FROM profiles
      WHERE id = p_user_id;
      
      -- Register for lucky draw if not already registered
      INSERT INTO lucky_draw_entries(user_id, name, student_id)
      VALUES (p_user_id, v_profile.name, v_profile.student_id)
      ON CONFLICT (user_id) DO NOTHING;
    END IF;
  END IF;

  RETURN v_ticket_count;
END;
$function$;